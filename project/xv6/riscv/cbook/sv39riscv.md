# 4.4 Sv39：基于页面的39位虚拟内存系统。

出发地：https://riscv.org/specifications/privileged-isa/。

本节描述一个为RV64系统设计的简单分页虚拟内存系统，它支持39位虚拟地址空间。Sv39的设计遵循Sv32的总体方案，本节仅详细说明方案之间的差异。

>我们为RV64指定了多个虚拟内存系统，以缓解提供大地址空间和最小化地址转换成本之间的紧张关系。对于许多系统，512 GiB的虚拟地址空间已经足够，因此Sv39就足够了。Sv48将虚拟地址空间增加到256TiB，但增加了专用于页表的物理内存容量、页表遍历的延迟以及存储虚拟地址的硬件结构的大小。

##4.4.1寻址和内存保护。

Sv39实施支持39位虚拟地址空间，分为4 KiB页。Sv39地址分区如图4.16所示。指令提取地址以及加载和存储有效地址(64位)必须具有全部等于位38的位63-39，否则将发生页面错误异常。27位VPN通过三级页表转换为44位PPN，而12位页面偏移量未转换。

>在较窄地址和较宽地址之间映射时，RISC-V通常将较窄地址零扩展到较宽地址。64位虚拟地址和Sv39的39位可用地址空间之间的映射不是基于零扩展，而是遵循一个根深蒂固的约定，该约定允许操作系统使用全尺寸(64位)虚拟地址的一个或几个最高有效位来快速区分用户和管理程序地址区域。

Sv39页表包含29个页表条目(PTE)，每个条目8字节。页表的大小与页面完全相同，并且必须始终与页面边界对齐。根页表的物理页号存储在SATP寄存器的PPN字段中。Sv39的PTE格式如图4.18所示。位9-0的含义与Sv32相同。位63-54保留供将来使用，并且必须由软件归零以实现前向兼容性。

>我们为可能的扩展预留了几个PTE位，该扩展允许跳过页表级，从而减少内存使用和TLB重新填充延迟，从而改善对稀疏地址空间的支持。这些保留位还可用于促进研究实验。成本降低了物理地址空间，但目前64 PiB就足够了。当它不再足够时，保持未分配的保留位可用于扩展物理地址空间。

任何级别的PTE都可以是叶PTE，因此除了4 KiB页之外，Sv39还支持2 MiB兆页和1 GiB千兆页，每个页面都必须在虚拟和物理上与其大小相等的边界对齐。如果物理地址未充分对齐，则会引发页面错误异常。虚拟到物理地址转换的算法与第4.3.2节中的算法相同，不同之处在于级别等于3，PTESIZE等于8。

## xv6-riscv 補充

xv6在Sv39 RISC-V上运行，Sv39 RISC-V具有39位虚拟地址(参见图3.1)。64位虚拟地址的前25位未使用。在此Sv39配置中，RISC-V页表在逻辑上是227(134,217,728)‘页表条目’(PTE)的数组。每个PTE包含44位物理页号(PPN)和一些标志。寻呼硬件通过使用39位的最高27位来索引到页表中以找到PTE，并制作其最高44位来自PTE中的PPN并且其最低12位从原始虚拟地址复制的56位物理地址来转换虚拟地址。因此，页表以4096(212)字节的对准块的粒度向操作系统提供对虚拟到物理地址转换的控制。这样的块称为页面。

在Sv39 RISC-V中，虚拟地址的前25位不用于转换；将来，RISC-V可能会使用这些位来定义更多级别的转换。同样，物理地址也有增长空间；在Sv39中，它是56位，但可以增长到64位。


